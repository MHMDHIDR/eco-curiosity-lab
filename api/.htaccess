<IfModule mod_rewrite.c>
    RewriteEngine On

    # Handle Angular and React Router
    RewriteBase /

    # Force HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Handle CORS preflight OPTIONS requests
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=200,L]

    # Laravel API Routes
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^(.*)$ public/index.php [QSA,L]

</IfModule>

# Security Headers

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# CORS Headers for API - Dynamic Origin Handling

<IfModule mod_headers.c>
    # Handle multiple allowed origins
    SetEnvIf Origin "^(https://ecocuriositylab\.me|http://localhost:8080|http://localhost:3000|http://localhost:5173|http://127\.0\.0\.1:8080|http://127\.0\.0\.1:3000|http://127\.0\.0\.1:5173)$" AccessControlAllowOrigin=$0

    Header always set Access-Control-Allow-Origin "%{AccessControlAllowOrigin}e" env=AccessControlAllowOrigin
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH"
    Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "3600"

    # Fallback for local development
    Header always set Access-Control-Allow-Origin "*" "expr=%{HTTP:Origin} =~ m#^http://localhost#"

    # Handle actual requests
    SetEnvIf Origin "https://ecocuriositylab.me" CORS_ALLOWED_ORIGIN=$0
    Header always set Access-Control-Allow-Origin "%{CORS_ALLOWED_ORIGIN}e" env=CORS_ALLOWED_ORIGIN

    # For development
    SetEnvIf Origin "http://localhost:3000" CORS_ALLOWED_ORIGIN=$0
    Header always set Access-Control-Allow-Origin "%{CORS_ALLOWED_ORIGIN}e" env=CORS_ALLOWED_ORIGIN

    SetEnvIf Origin "http://localhost:5173" CORS_ALLOWED_ORIGIN=$0
    Header always set Access-Control-Allow-Origin "%{CORS_ALLOWED_ORIGIN}e" env=CORS_ALLOWED_ORIGIN

</IfModule>

# Prevent access to sensitive files

<Files .env>
Order allow,deny
Deny from all
</Files>

<Files composer.json>
    Order allow,deny
    Deny from all
</Files>

<Files composer.lock>
    Order allow,deny
    Deny from all
</Files>

<Files package.json>
    Order allow,deny
    Deny from all
</Files>
